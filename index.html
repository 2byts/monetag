<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Earn by Watching Ads</title>
  <script src="//libtl.com/sdk.js" data-zone="9503680" data-sdk="show_9503680"></script>
</head>
<body>
  <h2>🎁 Watch Ads & Earn!</h2>
  <button id="watchAdBtn">▶️ Watch Ad</button>

  <script>
    const watchAdBtn = document.getElementById('watchAdBtn');

    // Try to get Telegram user ID from Telegram WebApp API if available
    let userId = null;
    if (window.Telegram?.WebApp) {
      const tgUser = Telegram.WebApp.initDataUnsafe?.user;
      userId = tgUser?.id;
      console.log("User ID from Telegram WebApp:", userId);
    }

    // Fallback: get user ID from URL parameter
    if (!userId) {
      userId = new URLSearchParams(location.search).get('id');
      console.log("User ID from URL param:", userId);
    }

    if (!userId) {
      alert("❌ Missing user ID in URL parameters or Telegram WebApp.");
      watchAdBtn.disabled = true;
    }

    watchAdBtn.onclick = function() {
      watchAdBtn.disabled = true;
      show_9503680()
        .then(() => {
          return fetch("https://9869-103-138-145-240.ngrok-free.app/api/reward", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: userId })
          });
        })
        .then(response => {
          if (!response.ok) throw new Error('Server error');
          alert("✅ Reward added!");
        })
        .catch(error => {
          console.error("Error:", error);
          alert("❌ Failed to contact server or ad was skipped.");
        })
        .finally(() => {
          watchAdBtn.disabled = false;
        });
    };
  </script>
</body>
</html>
