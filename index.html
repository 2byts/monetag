<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Earn by Watching Ads</title>
  <script src="//libtl.com/sdk.js" data-zone="9503680" data-sdk="show_9503680"></script>
</head>
<body>
  <h2>🎁 Watch Ads & Earn!</h2>
  <button id="watchAdBtn">▶️ Watch Ad</button>

  <script>
    const watchAdBtn = document.getElementById('watchAdBtn');

    // Function to get userId either from Telegram WebApp or URL param
    function getUserId() {
      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
        const tgUser = Telegram.WebApp.initDataUnsafe.user;
        if (tgUser && tgUser.id) {
          console.log("User ID from Telegram WebApp:", tgUser.id);
          return tgUser.id;
        }
      }
      const urlUserId = new URLSearchParams(window.location.search).get('id');
      if (urlUserId) {
        console.log("User ID from URL param:", urlUserId);
        return urlUserId;
      }
      return null;
    }

    const userId = getUserId();

    if (!userId) {
      alert("❌ Missing user ID in URL parameters or Telegram WebApp.");
      watchAdBtn.disabled = true;
    }

    watchAdBtn.addEventListener('click', () => {
      watchAdBtn.disabled = true;
      show_9503680()
        .then(() => {
          return fetch("https://9869-103-138-145-240.ngrok-free.app/api/reward", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: userId })
          });
        })
        .then(response => {
          if (!response.ok) {
            if(response.status === 400) {
              alert("❌ You are not registered. Please use the bot to register first.");
            } else {
              throw new Error('Server error');
            }
          } else {
            alert("✅ Reward added!");
          }
        })
        .catch(error => {
          console.error("Error:", error);
          alert("❌ Failed to contact server or ad was skipped.");
        })
        .finally(() => {
          watchAdBtn.disabled = false;
        });
    });
  </script>
</body>
</html>
